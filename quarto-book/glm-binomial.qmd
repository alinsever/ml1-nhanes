---
title: "Feeling Depressed Investigation"
subtitle: "Binomial General Linear Model"
format: html
---

```{r}
#| label: "libraries"
#| warning: false
#| message: false
#| include: false

library(tidyverse)
library(patchwork)
library(NHANES)
library(car)
library(pROC)
library(mgcv)
library(here)

```

```{r}
#| label: "nhanes dataset"
#| include: false

data(NHANES)
# str(NHANES)

# Subset with ~20 variables (all types included)
nhanes_sub <- NHANES %>%
  select(
    # demography
    SurveyYr, Gender, Age, AgeDecade, Race1, Education, MaritalStatus,
    HHIncome, HHIncomeMid, Poverty, HomeRooms, HomeOwn,
    
    # health (continuous + categorical)
    Height, Weight, BMI, HealthGen,
    Pulse, BPSysAve, BPDiaAve,
    
    # behaviour & life style
    PhysActive, PhysActiveDays, SleepHrsNight, SleepTrouble,
    Alcohol12PlusYr, AlcoholDay, AlcoholYear,
    SmokeNow, Smoke100, SmokeAge,
    
    # mental health
    DaysPhysHlthBad, DaysMentHlthBad,
    LittleInterest, Depressed
  )

str(nhanes_sub)

```

Mental health is a key public health concern, and NHANES provides rich data for examining factors linked to depressive symptoms. In this chapter, we use a binomial Generalized Linear Model (GLM) to investigate how demographic, socioeconomic, social, and lifestyle variables relate to depression. The GLM analysis also serves as a foundation for the more flexible modeling approach introduced in Chapter 4.

### Research questions

1.  Which demographic, socioeconomic, social, and lifestyle factors are most strongly associated with depressive symptoms?

2.  How does removing non-significant or conceptually overlapping predictors influence the model’s fit and interpretability?

3.  How well does the model discriminate between depressed and non-depressed individuals, and which classification threshold performs best?

### Make outcome variable Depressed (three levels) binary

```{r}
#| label: "Depressed binomial"
#| warning: false
#| message: false

# summary(nhanes_sub$Depressed)

nhanes_sub <- nhanes_sub %>%
  mutate(
    Depressed_bin = case_when(
      Depressed == "None" ~ "no",
      Depressed %in% c("Several", "Most") ~ "yes",
      TRUE ~ NA_character_
    ),
    Depressed_bin = factor(Depressed_bin, levels = c("no", "yes"))
  )

# Check the recode
table(nhanes_sub$Depressed_bin, useNA = "ifany")

```

### Visual inspection of Variable Depressed_bin

```{r}
#| label: "Depressed_bin Visuals"
#| warning: false
#| message: false
#| fig-height: 3
#| fig-width: 6

p_sleep_hours <- ggplot(
  filter(nhanes_sub, !is.na(Depressed_bin)),
  aes(x = Depressed_bin, y = SleepHrsNight)
) +
  geom_boxplot() +
  labs(title = "Sleep Hours vs Depression",
       x = "Depressive Symptoms", y = "Sleep Hours")

p_sleep_trouble <- ggplot(
  filter(nhanes_sub, !is.na(Depressed_bin)),
  aes(x = SleepTrouble, fill = Depressed_bin)
) +
  geom_bar(position = "fill") +
  labs(title = "Sleep Trouble vs Depression",
       x = "Sleep Trouble", y = "Proportion") +
  scale_y_continuous(labels = scales::percent_format())

p_sleep_hours + p_sleep_trouble


p_age <- ggplot(
  filter(nhanes_sub, !is.na(Depressed_bin)),
  aes(x = Depressed_bin, y = Age)
) +
  geom_boxplot() +
  labs(title = "Age vs Depression",
       x = "Depressive Symptoms", y = "Age")

p_poverty <- ggplot(
  filter(nhanes_sub, !is.na(Depressed_bin)),
  aes(x = Depressed_bin, y = Poverty)
) +
  geom_boxplot() +
  labs(title = "Poverty Index vs Depression",
       x = "Depressive Symptoms", y = "Poverty Index")

p_age + p_poverty


p_health <- ggplot(
  filter(nhanes_sub, !is.na(Depressed_bin)),
  aes(x = HealthGen, fill = Depressed_bin)
) +
  geom_bar(position = "fill") +
  labs(title = "General Health vs Depression",
       x = "General Health", y = "Proportion") +
  theme(axis.text.x = element_text(angle=45, hjust=1)) +
  scale_y_continuous(labels = scales::percent_format())

p_phys <- ggplot(
  filter(nhanes_sub, !is.na(Depressed_bin)),
  aes(x = PhysActive, fill = Depressed_bin)
) +
  geom_bar(position = "fill") +
  labs(title = "Physical Activity vs Depression",
       x = "Physical Activity", y = "Proportion")

p_health + p_phys

# # Gender vs Depressed
# ggplot(filter(nhanes_sub, !is.na(Depressed_bin)), aes(x = Gender, fill = Depressed_bin)) +
#   geom_bar(position = "fill")

# # MaritalStatus vs Depressed
# ggplot(filter(nhanes_sub, !is.na(Depressed_bin)), aes(x = MaritalStatus, fill = Depressed_bin)) +
#   geom_bar(position = "fill") +
#   theme(axis.text.x = element_text(angle=45, hjust=1))

# # PhysActive nach MaritalStatus
# ggplot(filter(nhanes_sub, !is.na(Depressed_bin)), 
#        aes(x = PhysActive, fill = Depressed_bin)) +
#   geom_bar(position = "fill") +
#   facet_wrap(~ MaritalStatus)

# # BMI vs Depressed
# ggplot(filter(nhanes_sub, !is.na(Depressed_bin)), aes(x = Depressed_bin, y = BMI)) +
#   geom_boxplot()

# library(ggmosaic)
# ggplot(filter(nhanes_sub, !is.na(Depressed_bin))) +
#  geom_mosaic(aes(x = product(Gender, MaritalStatus), fill = Depressed_bin)) +
#  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# # SleepTrouble nach Gender
# ggplot(filter(nhanes_sub, !is.na(Depressed_bin)), 
#        aes(x = SleepTrouble, fill = Depressed_bin)) +
#   geom_bar(position = "fill") +
#   facet_wrap(~ Gender)

```

### Selection of variables

Previous research has shown that depression is often associated with demographic, socioeconomic, social, health, and lifestyle factors. Based on these findings and after visual inspection of the graphs above, the following 9 variables are included in the first model:

-   **Demographic**: Age, Gender\
-   **Socioeconomic**: Poverty\
-   **Social**: MaritalStatus\
-   **Health-related**: BMI, HealthGen\
-   **Sleep / Activity**: SleepHrsNight, SleepTrouble, PhysActive

These choices are supported by findings in NHANES-based studies, where factors such as poverty, marital status, physical activity, sleep problems, BMI, and general health perception were among the strongest predictors of depression (see e.g. Zhang et al., *BMC Medical Informatics and Decision Making*, 2025).

### Handling of missings

```{r}
#| label: "Missings"
#| warning: false
#| message: false
#| include: false

Depressed_data <- nhanes_sub %>%
  filter(!is.na(Depressed_bin))

vars_model <- c("Depressed_bin", "Age", "Gender", "Poverty", "MaritalStatus", "BMI", "HealthGen", "SleepHrsNight", "SleepTrouble", "PhysActive")

Depressed_data %>%
  select(all_of(vars_model)) %>%
  summarise(across(everything(), ~ sum(is.na(.)))) %>%
  pivot_longer(cols = everything(),
                      names_to = "Variable", values_to = "Missing_Count")

```

```{r}
#| label: "Impute_Missings"
#| warning: false
#| message: false

Depressed_data_imp <- Depressed_data %>%
  mutate(
    Poverty = ifelse(is.na(Poverty), median(Poverty, na.rm = TRUE), Poverty),
    BMI = ifelse(is.na(BMI), median(BMI, na.rm = TRUE), BMI),
    SleepHrsNight = ifelse(is.na(SleepHrsNight), median(SleepHrsNight, na.rm = TRUE), SleepHrsNight),)

# Depressed_data_imp %>%
#   select(all_of(vars_model)) %>%
#   summarise(across(everything(), ~ sum(is.na(.)))) %>%
#   pivot_longer(cols = everything(),
#                       names_to = "Variable", values_to = "Missing_Count")

saveRDS(Depressed_data_imp, "depressed_imp.rds")

```

There were missing values in `Poverty` (443), `MaritalStatus` (236), `BMI` (51), and `SleepHrsNight` (13), while all other variables were complete. Missing values in `Poverty`, `BMI`, and `SleepHrsNight` were imputed using the median, whereas no suitable imputation strategy was identified for `MaritalStatus`.

### Model 1: Full model

```{r}
#| label: "GLM_Binomial_1"
#| warning: false
#| message: false

glm_depressed_1 <- glm(Depressed_bin ~ Age + Gender + Poverty + MaritalStatus + BMI +
                   HealthGen + SleepHrsNight + SleepTrouble + PhysActive,
                   data = Depressed_data_imp,
                   family = binomial)
coef(summary(glm_depressed_1))

```

There is **strong evidence against the null hypothesis** that `Gender`, `Poverty`, `MaritalStatus`, `HealthGen`, `SleepHrsNight`, `SleepTrouble` and `PhysActivitie` have no effect. Whereas `Age` and `BMI` show **no significant effect** on Depressed_bin.

**Interpretation example**: For individuals who are married, the log-odds of being depressed are 0.70 lower compared to the reference group (estimate = –0.704). Exponentiating the coefficient indicates that being married is associated with roughly a 50% reduction in the odds of depression (OR ≈ 0.49), providing strong evidence against the null hypothesis that marital status has no effect.

#### Checking for Collinearity

I am concerned about potential collinearity between the predictors, as this could hinder a proper interpretation of their individual effects. Therefore, I checked the model for signs of collinearity.

```{r}
#| label: "GLM_Binomial_1_Collinear"
#| warning: false
#| message: false

max(vif(glm_depressed_1)[ , "GVIF^(1/(2*Df))"])

```

All VIF values are \<2, meaning the model does not suffer from collinearity.

### Model 2: Removing non-significant predictors

<details>

<summary>Show output</summary>

```{r}
#| label: "GLM_Binomial_2"
#| warning: false
#| message: false

glm_depressed_2 <- glm(Depressed_bin ~ Gender + Poverty + MaritalStatus + HealthGen + SleepHrsNight + SleepTrouble + PhysActive,
                       data = Depressed_data_imp,
                       family = binomial)
coef(summary(glm_depressed_2))

```

</details>

Do all variables **contribute significantly** to the quality of the model?

<details>

<summary>Show output</summary>

```{r}
#| label: "Glm_depressed_2_drop1"
#| warning: false
#| message: false

drop1(glm_depressed_2, test = "Chisq")[ , "Pr(>Chi)", drop = FALSE]

```

</details>

All seven predictors showed significant χ² tests and thus contribute meaningfully to the model fit.

### Model 3: Removing conceptually collinear predictor (HealthGen)

`HealthGen` was removed in Model 3 because self-rated general health overlaps conceptually with depressive symptoms. Since the aim is interpretation rather than maximizing predictive accuracy, excluding `HealthGen` avoids this conceptual redundancy.

<details>

<summary>Show output</summary>

```{r}
#| label: "GLM_Binomial_3"
#| warning: false
#| message: false

glm_depressed_3 <- glm(Depressed_bin ~ Gender + Poverty + MaritalStatus + SleepHrsNight + SleepTrouble + PhysActive,
                       data = Depressed_data_imp,
                       family = binomial)
coef(summary(glm_depressed_3))

```

</details>

To evaluate the discriminatory power of this logistic regression model, a **ROC (Receiver Operating Characteristic)** analysis is performed using the pROC package.

```{r}
#| label: "GLM_Binomial_3_ROC"
#| warning: false
#| message: false
#| fig-height: 3
#| fig-width: 6

roc(glm_depressed_3$y, fitted(glm_depressed_3))

# ROC-Kurve plotten
roc_obj <- roc(glm_depressed_3$y, fitted(glm_depressed_3))
plot(roc_obj)

```

The AUC of 0.706 indicates that the model has a good discriminatory ability, correctly ranking depressed individuals above non-depressed individuals in about 71% of all case–control pairs.

#### ANOVA: comparing GLM models 2 and 3

As a **preliminary check**, an analysis of deviance (ANOVA) is being conducted to test whether `HealthGen` in model 2 significantly improves model fit compared to model 3.

```{r}
#| label: "ANOVA_model comparison"
#| warning: false
#| message: false

anova_res <- anova(glm_depressed_2, glm_depressed_3, test = "Chisq")

delta_dev <- anova_res$Deviance[2]     # Modell 3 vs. Modell 2
p_val     <- anova_res$`Pr(>Chi)`[2]   # p-Wert

delta_dev
p_val


```

Removing `HealthGen` worsened model fit substantially (ΔDeviance = 146.46, p \< 0.001), confirming its strong but conceptually overlapping contribution.

#### Akaike Information Criterion (AIC)

The AIC is a commonly used measure of model fit that balances model accuracy and complexity. It is chosen because it allows a direct **comparison between models with different numbers of parameters**, penalizing excessive complexity while rewarding better data fit.

```{r}
#| label: "AIC_GLM_model comparison"
#| warning: false
#| message: false

AIC(glm_depressed_3, glm_depressed_2)

```

Model 2 (AIC = 5978.8) outperformed Model 3 (AIC = 6117.2), confirming the added explanatory value of `HealthGen`.

### Confusion matrix

We next assess the predictive performance of the models using confusion matrices.

```{r}
#| label: "Evaluate models function"
#| echo: false
#| warning: false
#| message: false

eval_model <- function(model, threshold = 0.5) {
  pred_prob <- fitted(model)
  pred_class <- ifelse(pred_prob > threshold, "yes", "no")
  pred_class <- factor(pred_class, levels = c("no", "yes"))

  actual <- factor(ifelse(model$y == 1, "yes", "no"), levels = c("no", "yes"))

  cm <- table(Predicted = pred_class, Actual = actual)

  list(
    # confusion_matrix = cm,
    accuracy = sum(diag(cm)) / sum(cm),
    sensitivity = cm[2,2] / sum(cm[,2]),
    specificity = cm[1,1] / sum(cm[,1]),
    precision = cm[2,2] / sum(cm[2,])
  )
}
```

Then we use the function to calculate these measures for the two models.

<details>

<summary>Show output</summary>

```{r}
#| label: "Evaluate models"
#| echo: false
#| warning: false
#| message: false

show_eval <- function(model, name) {
  cat("###", name, "\n")
  out <- eval_model(model)
  print(out$confusion_matrix)
  cat(
    sprintf("\nAccuracy: %.3f\nSensitivity: %.3f\nSpecificity: %.3f\nPrecision: %.3f\n",
            out$accuracy, out$sensitivity, out$specificity, out$precision)
  )
}

show_eval(glm_depressed_2, "GLM Model 2 (without Age and BMI)")
cat("\n")
show_eval(glm_depressed_3, "GLM Model 3 (without Age, BMI, HealthGen)")

```

</details>

#### Results of Confusion Matrices

Model 2 showed higher accuracy (0.79), sensitivity (0.15), and precision (0.55) than Model 3, confirming better predictive performance. This indicates that HealthGen substantially improves the model’s ability to correctly identify depressed individuals, even though it may not be conceptually independent from the outcome.

#### Optimal classification threshold

Because the default threshold of 0.5 yielded very low sensitivity, adjusting the classification threshold can be reasonable. Lowering the threshold typically increases the model’s ability to identify depressed individuals, which may be more important depending on the research goal. Here the optimal threshold is determined based on the ROC curve for **model 3**.

```{r}
#| label: "Optimal_Threshold_GLM"
#| warning: false
#| message: false

coords(roc_obj, "best", ret = c("threshold", "sensitivity", "specificity"))
```

With the default threshold of 0.5, the model detects only 15% of depressed individuals, meaning that most true cases are misclassified as non-depressed. After lowering the threshold to 0.22, sensitivity increases to 61%, making the model substantially better at identifying depressed individuals.

### Note on Overdispersion

Because `Depressed_bin` consists of individual Bernoulli observations (0/1), overdispersion is not an issue for this analysis.

### Final remark on model selection

Model 2, which includes `HealthGen`, provides the best statistical fit and is preferable for prediction. Model 3, which excludes `HealthGen`, yields a less optimal fit but offers clearer interpretability of the other predictors. Therefore, **Model 2** is suited for predictive purposes, whereas **Model 3** is more appropriate for understanding how socioeconomic and lifestyle factors relate to depressive symptoms.

### Research questions answered

1.  **Key predictors of depression**: Gender, poverty, marital status, general health, sleep duration, sleep trouble, and physical activity were significantly related to depressive symptoms, whereas age and BMI showed no meaningful effects.

2.  **Effects of removing predictors**: Dropping non-significant variables improved interpretability, but removing HealthGen greatly worsened model fit. Thus, the model including HealthGen performs best statistically, while the reduced model offers clearer interpretation.

3.  **Model discrimination and threshold**: The model showed moderate discrimination (AUC ≈ 0.71). Lowering the classification threshold from 0.5 to 0.22 substantially improved sensitivity, making it more effective at identifying depressed individuals.
